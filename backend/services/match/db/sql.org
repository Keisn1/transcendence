:PROPERTIES:
:header-args:sqlite: :db match.db :header yes
:END:
#+title: Sql

* Tables
#+begin_src sqlite
.tables
#+end_src

#+RESULTS:
: matches            schema_migrations

* Matches
** get all Matches
#+begin_src sqlite
SELECT * FROM matches;
#+end_src

#+RESULTS:
| id                                   | player1Id                            |                            player2Id | player1Score | player2Score | gameMode   | duration | created_at          |
| 9dc1bfe8-2e48-4b83-a9b4-ec278ac179ce | f3a7f773-59b7-42f1-aa53-475ad90a4f5e | 00000000-0000-0000-0000-000000000000 |            1 |            5 | pvp        |    16078 | 2025-08-14 05:27:48 |
| 6e2d61dc-ac4a-4ad1-bf9c-f61e760787d3 | 4822a6be-b04e-4c45-b88a-a7a07d47f9aa | f3a7f773-59b7-42f1-aa53-475ad90a4f5e |            2 |            5 | tournament |    14046 | 2025-08-14 05:39:04 |
| 15b94bd2-a666-40f1-a695-5ffabf61b2e1 | f3a7f773-59b7-42f1-aa53-475ad90a4f5e | 00000000-0000-0000-0000-000000000002 |            0 |            5 | ai-hard    |    12970 | 2025-08-14 05:40:49 |

** get match by userId
#+begin_src sqlite
SELECT * FROM matches WHERE player1Id = 'f13e547b-9c63-4e97-b8dc-366550d49717' OR player2ID = 'f13e547b-9c63-4e97-b8dc-366550d49717';
#+end_src

#+RESULTS:

* Tournaments
** get all tournaments
#+begin_src sqlite
SELECT * FROM tournaments;
#+end_src

#+RESULTS:
| id                                   | name | player_count | status  | created_at          |
| 460922a9-c011-46fd-b63c-50c599a10642 |      |            2 | pending | 2025-08-11 08:46:24 |

** get all tournaments_participants

#+begin_src sqlite
SELECT * FROM tournament_participants;
#+end_src

#+RESULTS:
| tournament_id                        | player_id                            |
| 460922a9-c011-46fd-b63c-50c599a10642 | c56c4312-6cde-4058-ad37-2ef02e7477a7 |
| 460922a9-c011-46fd-b63c-50c599a10642 | bbf99621-cbd7-4246-ad30-ce53bf6ab83e |

** get participants of the tournament
#+begin_src sqlite
SELECT player_id
FROM tournament_participants
WHERE tournament_id = 'c68cb18a-cfbe-42ed-b32b-637632a689ff'
#+end_src

*** more difficult query
#+begin_src sqlite
SELECT
    tournament_id,
    MAX(CASE WHEN rn = 1 THEN player_id END) as player_id1,
    MAX(CASE WHEN rn = 2 THEN player_id END) as player_id2,
    MAX(CASE WHEN rn = 3 THEN player_id END) as player_id3,
    MAX(CASE WHEN rn = 4 THEN player_id END) as player_id4
FROM (
    SELECT
        tournament_id,
        player_id,
        ROW_NUMBER() OVER (PARTITION BY tournament_id ORDER BY player_id) as rn
    FROM tournament_participants
) ranked
GROUP BY tournament_id;
#+end_src

#+RESULTS:
| tournament_id                        | player_id1                           | player_id2                           | player_id3 | player_id4 |
| 89f4e71e-7e8a-4c78-8b6a-1e05b51a626a | 36a67ec1-cd9b-4f9d-974a-807051e1dab8 | f13e547b-9c63-4e97-b8dc-366550d49717 |            |            |

**** inner query
#+begin_src sqlite
SELECT 
       tournament_id, 
       player_id,
       ROW_NUMBER() OVER (PARTITION BY tournament_id ORDER BY player_id) as rn
FROM tournament_participants
#+end_src

#+RESULTS:
| tournament_id                        | player_id                            | rn |
| 89f4e71e-7e8a-4c78-8b6a-1e05b51a626a | 36a67ec1-cd9b-4f9d-974a-807051e1dab8 |  1 |
| 89f4e71e-7e8a-4c78-8b6a-1e05b51a626a | f13e547b-9c63-4e97-b8dc-366550d49717 |  2 |
