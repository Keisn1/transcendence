:PROPERTIES:
:header-args:sqlite: :db match.db :header yes
:END:
#+title: Sql

* Tables
#+begin_src sqlite
.tables
#+end_src

#+RESULTS:
: matches            schema_migrations

* Matches
** get all Matches
#+begin_src sqlite
SELECT * FROM matches;
#+end_src

#+RESULTS:
| id                                   | player1Id                            |                            player2Id | player1Score | player2Score | gameMode   | duration | created_at          |
| 24ca6b8f-07b5-4c7f-a00c-8c952d5eb29e | c56c4312-6cde-4058-ad37-2ef02e7477a7 | bbf99621-cbd7-4246-ad30-ce53bf6ab83e |            3 |            5 | pvp        |    17136 | 2025-08-11 08:48:35 |
| ce756e21-0b31-4423-9d34-dfd85d6096f0 | c56c4312-6cde-4058-ad37-2ef02e7477a7 | 00000000-0000-0000-0000-000000000000 |            5 |            4 | pvp        |    17635 | 2025-08-11 08:56:25 |
| 2ff0209b-40d9-45c9-a98e-6781b250b5fb | c56c4312-6cde-4058-ad37-2ef02e7477a7 | 00000000-0000-0000-0000-000000000001 |            2 |            5 | ai-easy    |    34264 | 2025-08-11 09:01:25 |
| 110df3ee-d4a8-45f8-8856-b8495b678638 | c56c4312-6cde-4058-ad37-2ef02e7477a7 | 00000000-0000-0000-0000-000000000002 |            0 |            5 | ai-hard    |    19965 | 2025-08-11 09:17:34 |
| 1c00a0e8-bb0d-484d-9f17-bf128e28b4f7 | c56c4312-6cde-4058-ad37-2ef02e7477a7 | 00000000-0000-0000-0000-000000000001 |            5 |            4 | ai-easy    |    33427 | 2025-08-11 09:18:15 |
| e6c0ed8d-3b9d-4b11-b271-439f52aea819 | c56c4312-6cde-4058-ad37-2ef02e7477a7 | 00000000-0000-0000-0000-000000000000 |            5 |            0 | pvp        |    11059 | 2025-08-11 09:18:33 |
| de72a182-9010-4d9f-8e04-b3bd98a9d11d | c56c4312-6cde-4058-ad37-2ef02e7477a7 | bbf99621-cbd7-4246-ad30-ce53bf6ab83e |            5 |            2 | tournament |    12756 | 2025-08-11 09:25:18 |

** get match by userId
#+begin_src sqlite
SELECT * FROM matches WHERE player1Id = 'f13e547b-9c63-4e97-b8dc-366550d49717' OR player2ID = 'f13e547b-9c63-4e97-b8dc-366550d49717';
#+end_src

#+RESULTS:
| id                                   | player1Id                            | player2Id                            | player1Score | player2Score | gameMode | duration | created_at          |
| 29c00d73-f658-4600-b971-5c17ef25cb94 | f13e547b-9c63-4e97-b8dc-366550d49717 | 36a67ec1-cd9b-4f9d-974a-807051e1dab8 |            2 |            5 | pvp      |    14530 | 2025-08-10 13:22:04 |
| e1cff8e3-3563-4e5b-8bf9-e5c026edbec2 | 36a67ec1-cd9b-4f9d-974a-807051e1dab8 | f13e547b-9c63-4e97-b8dc-366550d49717 |            5 |            0 | pvp      |    11436 | 2025-08-10 13:22:04 |
| 6667097c-6cec-4319-ad61-0a42a8f68109 | f13e547b-9c63-4e97-b8dc-366550d49717 | 00000000-0000-0000-0000-000000000000 |            5 |            2 | pvp      |    16364 | 2025-08-11 05:40:10 |

* Tournaments
** get all tournaments
#+begin_src sqlite
SELECT * FROM tournaments;
#+end_src

#+RESULTS:
| id                                   | name | player_count | status  | created_at          |
| 460922a9-c011-46fd-b63c-50c599a10642 |      |            2 | pending | 2025-08-11 08:46:24 |

** get all tournaments_participants

#+begin_src sqlite
SELECT * FROM tournament_participants;
#+end_src

#+RESULTS:
| tournament_id                        | player_id                            |
| 460922a9-c011-46fd-b63c-50c599a10642 | c56c4312-6cde-4058-ad37-2ef02e7477a7 |
| 460922a9-c011-46fd-b63c-50c599a10642 | bbf99621-cbd7-4246-ad30-ce53bf6ab83e |

** get participants of the tournament
#+begin_src sqlite
SELECT player_id
FROM tournament_participants
WHERE tournament_id = 'c68cb18a-cfbe-42ed-b32b-637632a689ff'
#+end_src

*** more difficult query
#+begin_src sqlite
SELECT
    tournament_id,
    MAX(CASE WHEN rn = 1 THEN player_id END) as player_id1,
    MAX(CASE WHEN rn = 2 THEN player_id END) as player_id2,
    MAX(CASE WHEN rn = 3 THEN player_id END) as player_id3,
    MAX(CASE WHEN rn = 4 THEN player_id END) as player_id4
FROM (
    SELECT
        tournament_id,
        player_id,
        ROW_NUMBER() OVER (PARTITION BY tournament_id ORDER BY player_id) as rn
    FROM tournament_participants
) ranked
GROUP BY tournament_id;
#+end_src

#+RESULTS:
| tournament_id                        | player_id1                           | player_id2                           | player_id3 | player_id4 |
| 89f4e71e-7e8a-4c78-8b6a-1e05b51a626a | 36a67ec1-cd9b-4f9d-974a-807051e1dab8 | f13e547b-9c63-4e97-b8dc-366550d49717 |            |            |

**** inner query
#+begin_src sqlite
SELECT 
       tournament_id, 
       player_id,
       ROW_NUMBER() OVER (PARTITION BY tournament_id ORDER BY player_id) as rn
FROM tournament_participants
#+end_src

#+RESULTS:
| tournament_id                        | player_id                            | rn |
| 89f4e71e-7e8a-4c78-8b6a-1e05b51a626a | 36a67ec1-cd9b-4f9d-974a-807051e1dab8 |  1 |
| 89f4e71e-7e8a-4c78-8b6a-1e05b51a626a | f13e547b-9c63-4e97-b8dc-366550d49717 |  2 |
